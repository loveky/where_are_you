!function(a,b){function c(){event.preventDefault();var c=b(this),d=c.siblings().find("input").val();""!==b.trim(d)&&b.trim(d)!==a.location.hash.substr(1)&&(a.location.hash=d)}function d(b){b.preventDefault(),B!==a.location.hash.substr(1)&&(o.remove(p),B=a.location.hash.substr(1),e(B))}function e(a){y&&(clearInterval(t),r.cancel()),n=new Firebase("https://brilliant-fire-2393.firebaseio.com/where_are_u/"+a),o=new GeoFire(n),k(),A.centerAndZoom(new BMap.Point(116.404,39.915),17),z=!1,s={},f(),t=setInterval(g,5e3),y=!0}function f(){void 0!==q?(r=o.query({center:[q.lat,q.lng],radius:5e3}),u=r.on("key_entered",function(a,b){noty({text:a+" 进入房间"}),i(a,b)}),v=r.on("key_exited",function(a){noty({text:a+" 离开房间"}),j(a)}),w=r.on("key_moved",function(a,b){m(a+" moved!"),i(a,b)})):setTimeout(f,1e3)}function g(){if(!navigator.geolocation)return void alert("Geolocation is not supported by your browser");var a=function(a){var b=new BMap.Point(a.coords.longitude,a.coords.latitude);BMap.Convertor.translate(b,0,h)},b=function(){console.log("Unable to retrieve your location")};navigator.geolocation.getCurrentPosition(a,b)}function h(a){m("经度: "+a.lng+", 纬度: "+a.lat),q=a,l(q)}function i(a,b){if(null!==b){var c=new BMap.Point(b[1],b[0]),d=new BMap.Marker(c);if(d.setTitle(a),a!==p){var e=new BMap.Label(a,{offset:new BMap.Size(15,-10)});d.setLabel(e);var f=new BMap.Icon("image/friend.png",new BMap.Size(20,20));d.setIcon(f)}j(a),A.addOverlay(d),z||a!==p||(A.setCenter(c),z=!0)}}function j(a){var b=A.getOverlays();for(x=0;x<b.length;x++)b[x].getTitle()===a&&A.removeOverlay(b[x])}function k(){for(var a=A.getOverlays(),b=0;b<a.length;b++)A.removeOverlay(a[b])}function l(a){o.set(p,[a.lat,a.lng])}function m(a){var b=new Date;console.log(b.toLocaleTimeString()+" "+a)}for(var n,o,p;!b.trim(p);)p=prompt("你的大名(用于显示给其他用户):");var q,r,s,t,u,v,w,x,y=!1,z=!1,A=a.map=new BMap.Map("map");A.addControl(new BMap.ScaleControl),A.addControl(new BMap.NavigationControl),A.centerAndZoom(new BMap.Point(116.404,39.915),17),b.extend(b.noty.defaults,{maxVisible:3,timeout:2e3,layout:"bottom",type:"information"});var B=a.location.hash.substr(1)||"default";e(B),b("#changeRoom").on("click",c),b(a).on("hashchange",d)}(window,window.jQuery);