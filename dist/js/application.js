!function(a,b){function c(){var c=b(a).innerHeight()-b("nav.navbar").height();b("#map").height(c)}function d(){var a=b(this);a.closest(".modal-content").find("button").attr("disabled",""===b.trim(a.val()))}function e(){b(this);r=b.trim(b("#askForNameModal input").val()),b("#askForNameModal").modal("hide")}function f(){event.preventDefault();var c=b(this),d=c.siblings().find("input").val();""!==b.trim(d)&&b.trim(d)!==a.location.hash.substr(1)&&(a.location.hash=d)}function g(b){b.preventDefault(),A!==a.location.hash.substr(1)&&(q.remove(r),A=a.location.hash.substr(1),h(A))}function h(a){B&&(clearInterval(v),t.cancel()),p=new Firebase("https://brilliant-fire-2393.firebaseio.com/where_are_u/"+a),q=new GeoFire(p),n(),D.centerAndZoom(new BMap.Point(116.404,39.915),17),C=!1,u={},i(),v=setInterval(j,5e3),B=!0}function i(){void 0!==s?(t=q.query({center:[s.lat,s.lng],radius:5e3}),w=t.on("key_entered",function(a,b){noty({text:a+" 进入房间"}),l(a,b)}),x=t.on("key_exited",function(a){noty({text:a+" 离开房间"}),m(a)}),y=t.on("key_moved",function(a,b){l(a,b)})):setTimeout(i,1e3)}function j(){if(!navigator.geolocation)return void alert("Geolocation is not supported by your browser");var a=function(a){var b=new BMap.Point(a.coords.longitude,a.coords.latitude);BMap.Convertor.translate(b,0,k)},b=function(){console.log("Unable to retrieve your location")};navigator.geolocation.getCurrentPosition(a,b)}function k(a){s=a,o(s)}function l(a,b){if(null!==b){var c=new BMap.Point(b[1],b[0]),d=new BMap.Marker(c);if(d.setTitle(a),a!==r){var e=new BMap.Label(a,{offset:new BMap.Size(15,-10)});d.setLabel(e);var f=new BMap.Icon("image/friend.png",new BMap.Size(20,20));d.setIcon(f)}m(a),D.addOverlay(d),C||a!==r||(D.setCenter(c),C=!0)}}function m(a){var b=D.getOverlays();for(z=0;z<b.length;z++)b[z].getTitle()===a&&D.removeOverlay(b[z])}function n(){for(var a=D.getOverlays(),b=0;b<a.length;b++)D.removeOverlay(a[b])}function o(a){q.set(r,[a.lat,a.lng])}var p,q,r,s,t,u,v,w,x,y,z,A,B=!1,C=!1,D=a.map=new BMap.Map("map");D.addControl(new BMap.ScaleControl),D.addControl(new BMap.NavigationControl),D.centerAndZoom(new BMap.Point(116.404,39.915),17),b.extend(b.noty.defaults,{maxVisible:3,timeout:2e3,layout:"bottom",type:"information"}),b("#askForNameModal").modal({keyboard:!1,show:!0,backdrop:"static"}).on("hidden.bs.modal",function(){A=a.location.hash.substr(1)||"default",h(A)}),b("#changeRoom").on("click",f),b(a).on("hashchange",g),b("#askForNameModal input").on("keyup",d),b("#askForNameModal button").on("click",e),b(a).on("resize",c).trigger("resize")}(window,window.jQuery);